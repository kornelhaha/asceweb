<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>asce.</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #canvas-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: #000;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .sidebar {
            width: 240px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 1.8em;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            font-size: 0.9em;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: #fff;
            color: #000;
            font-weight: 600;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .nav-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-item.locked:hover {
            background: transparent;
            color: #666;
            transform: none;
        }

        .nav-item i {
            font-size: 1.1em;
            width: 20px;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 8px;
            color: #ff4444;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            font-size: 0.85em;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }

        .logout-btn:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-family: 'Space Mono', monospace;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .user-license {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
        }

        .user-license.premium {
            color: #fff;
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 0;
            background: transparent;
        }

        .top-bar {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .page-title {
            font-size: 1.8em;
            font-family: 'Space Mono', monospace;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .connection-status-topbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.85em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f00;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }

        .status-dot.connected {
            background: #0f0;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.8);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(0, 255, 0, 0.8);
            }
            50% {
                box-shadow: 0 0 25px rgba(0, 255, 0, 1);
            }
        }

        .content-area {
            padding: 32px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .category-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .category-tab:hover {
            border-color: #fff;
            color: #fff;
        }

        .category-tab.active {
            background: #fff;
            color: #000;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.4);
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.4s ease;
            display: none;
        }

        .module-card.visible {
            display: block;
            animation: cardSlideIn 0.5s ease;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .module-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(255, 255, 255, 0.1);
            transform: translateY(-4px);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .module-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .module-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .module-toggle {
            position: relative;
            width: 52px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .module-toggle.active {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .module-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .module-toggle.active .module-toggle-slider {
            transform: translateX(24px);
            background: #000;
        }

        .module-settings {
            display: none;
        }

        .module-settings.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }

        .setting-group {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .setting-group-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mini-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .mini-toggle.active {
            background: #fff;
            border-color: #fff;
        }

        .mini-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .mini-toggle.active .mini-toggle-slider {
            transform: translateX(18px);
            background: #000;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .setting-label {
            font-size: 0.9em;
            color: #ccc;
        }

        .setting-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            color: #fff;
            font-weight: 600;
        }

        .cps-range-display {
            font-size: 0.75em;
            color: #888;
            margin-left: 4px;
        }

        .slider-container {
            width: 100%;
            margin-top: 8px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .expand-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            color: #fff;
        }

        .expand-btn i {
            transition: transform 0.3s ease;
        }

        .expand-btn.expanded i {
            transform: rotate(180deg);
        }

        .keybind-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

        .keybind-input:hover {
            border-color: #fff;
        }

        .keybind-input.recording {
            border-color: #0f0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            animation: recording-pulse 1s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .checkbox {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .checkbox i {
            display: none;
            font-size: 0.75em;
        }

        .checkbox.checked {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .checkbox.checked i {
            color: #000;
            display: block;
        }

        .license-required-message {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .license-required-message i {
            font-size: 3em;
            margin-bottom: 16px;
            color: #ffffff;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
        }

        .license-required-message h3 {
            font-size: 1.5em;
            margin-bottom: 12px;
            color: #fff;
        }

        .license-required-message p {
            margin-bottom: 24px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #fff;
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-family: 'Inter', sans-serif;
            text-decoration: none;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
        }

        .settings-container {
            max-width: 1200px;
        }

        .settings-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .settings-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            margin-bottom: -2px;
        }

        .settings-tab:hover {
            color: #fff;
        }

        .settings-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .settings-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .settings-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .settings-card-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #999;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9em;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #fff;
        }

        .btn-full {
            width: 100%;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-size: 0.85em;
        }

        .info-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            color: #fff;
        }

        .success-message,
        .error-message {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
            font-size: 0.85em;
            align-items: center;
            gap: 8px;
        }

        .success-message {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #0f0;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }

        .success-message.show,
        .error-message.show {
            display: flex;
        }

        .license-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
        }

        .license-badge.lifetime,
        .license-badge.month,
        .license-badge.week {
            background: #ffffff;
            color: #000000;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .license-badge.expired {
            background: rgba(255, 255, 255, 0.1);
            color: #666;
        }
    </style>
</head>
<body>
    <canvas id="canvas-background"></canvas>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">asce.</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" data-section="modules" data-requires-license="true" onclick="switchSection(event, 'modules')">
                    <i class="fas fa-th-large"></i>
                    <span>Modules</span>
                </div>
                <div class="nav-item" data-section="settings" onclick="switchSection(event, 'settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="nav-item" data-section="download" data-requires-license="true" onclick="switchSection(event, 'download')">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>

                <div class="user-profile" onclick="switchSection(event, 'settings')">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-license" id="userLicense"></div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #666; font-size: 0.8em;"></i>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="page-title">
                    <i id="pageTitleIcon" class="fas fa-th-large"></i>
                    <span id="pageTitle">Modules</span>
                </div>

                <div class="connection-status-topbar">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText">not connected</span>
                </div>
            </div>

            <div class="content-area">
                <!-- MODULES SECTION -->
                <div id="modules-section" class="content-section active">
                    <div id="modulesContent">
                        <div class="category-tabs">
                            <div class="category-tab active" data-category="combat">COMBAT</div>
                        </div>

                        <div class="module-grid">
                            <!-- LEFT CLICKER MODULE -->
                            <div class="module-card visible" data-category="combat">
                                <div class="module-header">
                                    <div class="module-title">
                                        <div class="module-icon"><i class="fas fa-mouse-pointer"></i></div>
                                        <span>Left Clicker</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <button class="expand-btn" onclick="toggleModuleSettings('leftclicker')">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="module-toggle" data-module="leftclicker" onclick="toggleModule('leftclicker')">
                                            <div class="module-toggle-slider"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="module-settings" id="leftclicker-settings">
                                    <div class="setting-row">
                                        <span class="setting-label">CPS</span>
                                        <span class="setting-value">
                                            <span id="cpsValue">10.0</span>
                                            <span class="cps-range-display" id="cpsRange">(9-11)</span>
                                        </span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" class="slider" min="1" max="25" step="0.1" value="10" 
                                               oninput="updateCps(this.value)" id="cpsSlider">
                                    </div>
                                    
                                    <div class="setting-row" style="margin-top: 16px;">
                                        <span class="setting-label">Hotkey</span>
                                        <input type="text" class="keybind-input" value="F6" readonly 
                                               onclick="recordKeybind(this)" id="hotkeyInput">
                                    </div>
                                    <div class="setting-row" style="margin-top: 16px;">
                                        <span class="setting-label">Hold to Click</span>
                                        <div class="checkbox" data-setting="holdToClick" onclick="toggleCheckbox(this, 'holdToClick')">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-label">Blatant Mode (exact CPS)</span>
                                        <div class="checkbox" data-setting="blatantMode" onclick="toggleCheckbox(this, 'blatantMode')">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>

                                    <!-- EXHAUST MODE -->
                                    <div class="setting-group" style="margin-top: 20px;">
                                        <div class="setting-group-header">
                                            <span class="setting-group-title">âš¡ Exhaust Mode</span>
                                            <div class="mini-toggle" data-setting="exhaustMode" onclick="toggleMiniSetting(this, 'exhaustMode')">
                                                <div class="mini-toggle-slider"></div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <span class="setting-label">Drop CPS</span>
                                            <span class="setting-value" id="exhaustDropValue">3.0</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="1" max="10" step="0.1" value="3" 
                                                   oninput="updateExhaustDrop(this.value)" id="exhaustDropSlider">
                                        </div>
                                        <div class="setting-row" style="margin-top: 12px;">
                                            <span class="setting-label">Trigger Chance</span>
                                            <span class="setting-value" id="exhaustChanceValue">50%</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="0" max="100" step="1" value="50" 
                                                   oninput="updateExhaustChance(this.value)" id="exhaustChanceSlider">
                                        </div>
                                    </div>

                                    <!-- SPIKE MODE -->
                                    <div class="setting-group">
                                        <div class="setting-group-header">
                                            <span class="setting-group-title">ðŸš€ Spike Mode</span>
                                            <div class="mini-toggle" data-setting="spikeMode" onclick="toggleMiniSetting(this, 'spikeMode')">
                                                <div class="mini-toggle-slider"></div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <span class="setting-label">Increase CPS</span>
                                            <span class="setting-value" id="spikeIncreaseValue">5.0</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="1" max="15" step="0.1" value="5" 
                                                   oninput="updateSpikeIncrease(this.value)" id="spikeIncreaseSlider">
                                        </div>
                                        <div class="setting-row" style="margin-top: 12px;">
                                            <span class="setting-label">Trigger Chance</span>
                                            <span class="setting-value" id="spikeChanceValue">30%</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="0" max="100" step="1" value="30" 
                                                   oninput="updateSpikeChance(this.value)" id="spikeChanceSlider">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BLOCKHIT MODULE -->
                            <div class="module-card visible" data-category="combat">
                                <div class="module-header">
                                    <div class="module-title">
                                        <div class="module-icon"><i class="fas fa-shield-alt"></i></div>
                                        <span>Blockhit</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <button class="expand-btn" onclick="toggleModuleSettings('blockhit')">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="module-toggle" data-module="blockhit" onclick="toggleModule('blockhit')">
                                            <div class="module-toggle-slider"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="module-settings" id="blockhit-settings">
                                    <div class="setting-row">
                                        <span class="setting-label">Block Chance</span>
                                        <span class="setting-value" id="blockChanceValue">50%</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" class="slider" min="0" max="100" step="1" value="50" 
                                               oninput="updateBlockChance(this.value)" id="blockChanceSlider">
                                    </div>

                                    <div style="margin-top: 20px;">
                                        <div class="setting-row">
                                            <span class="setting-label">Hold Length Min (ms)</span>
                                            <span class="setting-value" id="holdMinValue">50</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="500" step="5" value="50" 
                                                   oninput="updateHoldMin(this.value)" id="holdMinSlider">
                                        </div>
                                        <div class="setting-row" style="margin-top: 12px;">
                                            <span class="setting-label">Hold Length Max (ms)</span>
                                            <span class="setting-value" id="holdMaxValue">150</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="500" step="5" value="150" 
                                                   oninput="updateHoldMax(this.value)" id="holdMaxSlider">
                                        </div>
                                    </div>

                                    <div style="margin-top: 20px;">
                                        <div class="setting-row">
                                            <span class="setting-label">Delay Min (ms)</span>
                                            <span class="setting-value" id="delayMinValue">100</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="1000" step="10" value="100" 
                                                   oninput="updateDelayMin(this.value)" id="delayMinSlider">
                                        </div>
                                        <div class="setting-row" style="margin-top: 12px;">
                                            <span class="setting-label">Delay Max (ms)</span>
                                            <span class="setting-value" id="delayMaxValue">300</span>
                                        </div>
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="1000" step="10" value="300" 
                                                   oninput="updateDelayMax(this.value)" id="delayMaxSlider">
                                        </div>
                                    </div>

                                    <div class="setting-row" style="margin-top: 16px;">
                                        <span class="setting-label">Only While Clicking</span>
                                        <div class="checkbox checked" data-setting="onlyWhileClicking" 
                                             onclick="toggleCheckbox(this, 'onlyWhileClicking')">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noLicenseMessage" class="license-required-message" style="display: none;">
                        <i class="fas fa-lock"></i>
                        <h3>License Required</h3>
                        <p>You need an active license to access modules.</p>
                        <a href="#" class="btn" onclick="switchSection(event, 'settings'); return false;">
                            <i class="fas fa-key"></i> Activate License
                        </a>
                    </div>
                </div>

                <!-- SETTINGS SECTION -->
                <div id="settings-section" class="content-section">
                    <div class="settings-container">
                        <div class="settings-tabs">
                            <div class="settings-tab active" onclick="switchSettingsTab('account')">
                                <i class="fas fa-user"></i>
                                <span>Account</span>
                            </div>
                            <div class="settings-tab" onclick="switchSettingsTab('license')">
                                <i class="fas fa-certificate"></i>
                                <span>License</span>
                            </div>
                            <div class="settings-tab" onclick="switchSettingsTab('security')">
                                <i class="fas fa-lock"></i>
                                <span>Security</span>
                            </div>
                        </div>

                        <div id="account-tab" class="settings-tab-content active">
                            <div class="settings-grid">
                                <div class="settings-card">
                                    <div class="settings-card-title">
                                        <i class="fas fa-info-circle"></i>
                                        Account Information
                                    </div>
                                    <div class="info-box">
                                        <div class="info-row">
                                            <span class="info-label">Username</span>
                                            <span class="info-value" id="settingsUsername">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Email</span>
                                            <span class="info-value" id="settingsEmail">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Role</span>
                                            <span class="info-value" id="settingsRole">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Total Clicks</span>
                                            <span class="info-value" id="settingsClicks">-</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-card">
                                    <div class="settings-card-title">
                                        <i class="fas fa-envelope"></i>
                                        Change Email
                                    </div>
                                    <div class="success-message" id="emailSuccess">
                                        <i class="fas fa-check-circle"></i> Email updated!
                                    </div>
                                    <div class="error-message" id="emailError">
                                        <i class="fas fa-exclamation-circle"></i> <span id="emailErrorText"></span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">New Email Address</label>
                                        <input type="email" class="form-input" id="newEmailInput" placeholder="your@email.com">
                                    </div>
                                    <button class="btn btn-full" onclick="changeEmail()">
                                        <i class="fas fa-save"></i> Update Email
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="license-tab" class="settings-tab-content">
                            <div class="settings-grid">
                                <div class="settings-card">
                                    <div class="settings-card-title">
                                        <i class="fas fa-certificate"></i>
                                        Current License
                                    </div>
                                    <div class="info-box" id="licenseInfoBox">
                                        <div class="info-row">
                                            <span class="info-label">Type</span>
                                            <span class="info-value">
                                                <span class="license-badge" id="licenseBadge">Free</span>
                                            </span>
                                        </div>
                                        <div class="info-row" id="licenseExpiryRow" style="display: none;">
                                            <span class="info-label">Expires In</span>
                                            <span class="info-value" id="licenseExpiry">-</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-card" id="activationSection">
                                    <div class="settings-card-title">
                                        <i class="fas fa-key"></i>
                                        Activate License
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">License Key</label>
                                        <input type="text" class="form-input" id="licenseKeyInput" placeholder="XXXXX-XXXXX-XXXXX">
                                    </div>
                                    <button class="btn btn-full" onclick="activateLicense()">
                                        <i class="fas fa-check"></i> Activate Now
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="security-tab" class="settings-tab-content">
                            <div class="settings-grid">
                                <div class="settings-card">
                                    <div class="settings-card-title">
                                        <i class="fas fa-lock"></i>
                                        Change Password
                                    </div>
                                    <div class="success-message" id="passwordSuccess">
                                        <i class="fas fa-check-circle"></i> Password updated!
                                    </div>
                                    <div class="error-message" id="passwordError">
                                        <i class="fas fa-exclamation-circle"></i> <span id="passwordErrorText"></span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-input" id="currentPasswordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-input" id="newPasswordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-input" id="confirmPasswordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                    </div>
                                    <button class="btn btn-full" onclick="changePassword()">
                                        <i class="fas fa-save"></i> Update Password
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DOWNLOAD SECTION -->
                <div id="download-section" class="content-section">
                    <div id="downloadContent">
                        <div class="settings-container">
                            <div class="settings-card" style="max-width: 600px; margin: 0 auto;">
                                <div class="settings-card-title">
                                    <i class="fas fa-download"></i>
                                    Download asce. Client
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Filename</label>
                                    <input type="text" class="form-input" id="customFilename" placeholder="asce" value="asce">
                                </div>

                                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                    <button class="btn" style="flex: 1;" onclick="downloadClient(false)">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                    <button class="btn" style="flex: 1; background: rgba(255,255,255,0.1); color: #fff;" onclick="downloadClient(true)">
                                        <i class="fas fa-random"></i> Random Name
                                    </button>
                                </div>

                                <div id="downloadStatus" class="success-message">
                                    <i class="fas fa-check-circle"></i> <span id="downloadStatusText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noLicenseMessageDownload" class="license-required-message" style="display: none;">
                        <i class="fas fa-lock"></i>
                        <h3>License Required</h3>
                        <p>You need an active license to download the client.</p>
                        <a href="#" class="btn" onclick="switchSection(event, 'settings'); return false;">
                            <i class="fas fa-key"></i> Activate License
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
// ==================== CANVAS BACKGROUND ====================
const canvas = document.getElementById('canvas-background');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

class Particle {
    constructor() {
        this.reset();
    }

    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.radius = Math.random() * 2 + 1;
        this.alpha = Math.random() * 0.5 + 0.2;
    }

    update() {
        this.x += this.vx;
        this.y += this.vy;

        if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
    }

    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
        ctx.fill();
    }
}

const particles = [];
const particleCount = 100;
for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
}

let mouse = { x: null, y: null, radius: 150 };
canvas.addEventListener('mousemove', (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
});

canvas.addEventListener('mouseleave', () => {
    mouse.x = null;
    mouse.y = null;
});

function animate() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    particles.forEach(particle => {
        particle.update();
        particle.draw();
    });

    particles.forEach((p1, i) => {
        particles.slice(i + 1).forEach(p2 => {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 120) {
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.strokeStyle = `rgba(255, 255, 255, ${0.15 * (1 - distance / 120)})`;
                ctx.lineWidth = 0.5;
                ctx.stroke();
            }
        });

        if (mouse.x !== null && mouse.y !== null) {
            const dx = p1.x - mouse.x;
            const dy = p1.y - mouse.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < mouse.radius) {
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(mouse.x, mouse.y);
                ctx.strokeStyle = `rgba(255, 255, 255, ${0.3 * (1 - distance / mouse.radius)})`;
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }
    });

    requestAnimationFrame(animate);
}

animate();

// ==================== DASHBOARD LOGIC ====================
const API_URL = 'https://asce-f5us.onrender.com/api';
let currentConfig = {};
let currentUser = {};
let ws = null;
let isUpdatingFromServer = false;
let hasActiveLicense = false;
let lastSavedConfig = {};
let saveTimeout = null;

function isSessionValid() {
    const token = localStorage.getItem('token');
    const loginTime = localStorage.getItem('loginTime');
    if (!token || !loginTime) return false;
    
    const elapsed = Date.now() - parseInt(loginTime);
    return elapsed <= 60 * 60 * 1000; // 1 hour
}

async function init() {
    if (!isSessionValid()) {
        localStorage.clear();
        window.location.href = 'auth.html';
        return;
    }

    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'auth.html';
        return;
    }

    try {
        await loadUserProfile();
        await loadSettings();
        connectWebSocket(token);
    } catch (error) {
        console.error('Init error:', error);
    }
}

async function loadUserProfile() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`${API_URL}/user/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            currentUser = await response.json();
            updateUserDisplay();
            checkLicenseStatus();
        }
    } catch (error) {
        console.error('Profile load error:', error);
    }
}

function checkLicenseStatus() {
    hasActiveLicense = currentUser.license && currentUser.license.status === 'active';
    updateLicenseRestrictions();
}

function updateLicenseRestrictions() {
    const navItems = document.querySelectorAll('.nav-item[data-requires-license="true"]');
    navItems.forEach(item => {
        if (hasActiveLicense) {
            item.classList.remove('locked');
        } else {
            item.classList.add('locked');
        }
    });

    const modulesContent = document.getElementById('modulesContent');
    const noLicenseMessage = document.getElementById('noLicenseMessage');
    if (hasActiveLicense) {
        modulesContent.style.display = 'block';
        noLicenseMessage.style.display = 'none';
    } else {
        modulesContent.style.display = 'none';
        noLicenseMessage.style.display = 'block';
    }

    const downloadContent = document.getElementById('downloadContent');
    const noLicenseMessageDownload = document.getElementById('noLicenseMessageDownload');
    if (hasActiveLicense) {
        downloadContent.style.display = 'block';
        noLicenseMessageDownload.style.display = 'none';
    } else {
        downloadContent.style.display = 'none';
        noLicenseMessageDownload.style.display = 'block';
    }
}

function updateUserDisplay() {
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const userLicenseEl = document.getElementById('userLicense');
    
    if (userNameEl) userNameEl.textContent = currentUser.username || 'User';
    if (userAvatarEl) userAvatarEl.textContent = (currentUser.username || 'U').charAt(0).toUpperCase();
    
    if (userLicenseEl) {
        if (currentUser.license) {
            const timeRemaining = currentUser.license.timeRemaining || 'Lifetime';
            userLicenseEl.textContent = `${currentUser.license.type} â€¢ ${timeRemaining}`;
            userLicenseEl.classList.add('premium');
        } else {
            userLicenseEl.textContent = 'No License';
            userLicenseEl.classList.remove('premium');
        }
    }

    document.getElementById('settingsUsername').textContent = currentUser.username;
    document.getElementById('settingsEmail').textContent = currentUser.email;
    document.getElementById('settingsRole').textContent = currentUser.role;
    document.getElementById('settingsClicks').textContent = (currentUser.totalClicks || 0).toLocaleString();

    updateLicenseDisplay();
}

function updateLicenseDisplay() {
    const licenseBadge = document.getElementById('licenseBadge');
    const licenseExpiry = document.getElementById('licenseExpiry');
    const licenseExpiryRow = document.getElementById('licenseExpiryRow');
    const activationSection = document.getElementById('activationSection');

    if (currentUser.license) {
        licenseBadge.textContent = currentUser.license.type.charAt(0).toUpperCase() + currentUser.license.type.slice(1);
        licenseBadge.className = 'license-badge ' + currentUser.license.type;
        licenseExpiryRow.style.display = 'flex';
        licenseExpiry.textContent = currentUser.license.timeRemaining;
        activationSection.style.display = 'none';
    } else {
        licenseBadge.textContent = 'No License';
        licenseBadge.className = 'license-badge expired';
        licenseExpiryRow.style.display = 'none';
        activationSection.style.display = 'block';
    }
}

async function loadSettings() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`${API_URL}/agent/settings`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            currentConfig = await response.json();
            isUpdatingFromServer = true;
            applySettings(currentConfig);
            isUpdatingFromServer = false;
        }
    } catch (error) {
        console.error('Settings load error:', error);
    }
}

function calculateCpsRange(baseCps) {
    const variance = baseCps * 0.125;
    const minCps = Math.max(1, baseCps - variance).toFixed(1);
    const maxCps = Math.min(25, baseCps + variance).toFixed(1);
    return `(${minCps}-${maxCps})`;
}

function applySettings(config) {
    try {
        // Left Clicker Toggle
        const leftClickerToggle = document.querySelector('.module-toggle[data-module="leftclicker"]');
        if (leftClickerToggle) {
            if (config.enabled) leftClickerToggle.classList.add('active');
            else leftClickerToggle.classList.remove('active');
        }

        // CPS
        const cpsValue = document.getElementById('cpsValue');
        const cpsRange = document.getElementById('cpsRange');
        const cpsSlider = document.getElementById('cpsSlider');
        if (cpsValue && cpsSlider) {
            const cps = config.cps || 10;
            cpsValue.textContent = cps.toFixed(1);
            cpsSlider.value = cps;
            if (cpsRange) cpsRange.textContent = calculateCpsRange(cps);
        }

        // Hotkey
        const hotkeyInput = document.getElementById('hotkeyInput');
        if (hotkeyInput && config.hotkeyCode) {
            hotkeyInput.value = getKeyName(config.hotkeyCode);
        }

        // Checkboxes
        const holdToClick = document.querySelector('.checkbox[data-setting="holdToClick"]');
        if (holdToClick) {
            if (config.holdToClick) holdToClick.classList.add('checked');
            else holdToClick.classList.remove('checked');
        }

        const blatantMode = document.querySelector('.checkbox[data-setting="blatantMode"]');
        if (blatantMode) {
            if (config.blatantMode) blatantMode.classList.add('checked');
            else blatantMode.classList.remove('checked');
        }

        // Exhaust
        const exhaustToggle = document.querySelector('.mini-toggle[data-setting="exhaustMode"]');
        if (exhaustToggle) {
            if (config.exhaustMode) exhaustToggle.classList.add('active');
            else exhaustToggle.classList.remove('active');
        }

        if (document.getElementById('exhaustDropValue')) {
            const drop = config.exhaustDropCps || 3;
            document.getElementById('exhaustDropValue').textContent = drop.toFixed(1);
            document.getElementById('exhaustDropSlider').value = drop;
        }

        if (document.getElementById('exhaustChanceValue')) {
            const chance = config.exhaustChance || 50;
            document.getElementById('exhaustChanceValue').textContent = chance + '%';
            document.getElementById('exhaustChanceSlider').value = chance;
        }

        // Spike
        const spikeToggle = document.querySelector('.mini-toggle[data-setting="spikeMode"]');
        if (spikeToggle) {
            if (config.spikeMode) spikeToggle.classList.add('active');
            else spikeToggle.classList.remove('active');
        }

        if (document.getElementById('spikeIncreaseValue')) {
            const increase = config.spikeIncreaseCps || 5;
            document.getElementById('spikeIncreaseValue').textContent = increase.toFixed(1);
            document.getElementById('spikeIncreaseSlider').value = increase;
        }

        if (document.getElementById('spikeChanceValue')) {
            const chance = config.spikeChance || 30;
            document.getElementById('spikeChanceValue').textContent = chance + '%';
            document.getElementById('spikeChanceSlider').value = chance;
        }

        // Blockhit
        const blockhitToggle = document.querySelector('.module-toggle[data-module="blockhit"]');
        if (blockhitToggle) {
            if (config.blockhitEnabled) blockhitToggle.classList.add('active');
            else blockhitToggle.classList.remove('active');
        }

        if (document.getElementById('blockChanceValue')) {
            const chance = config.blockChance || 50;
            document.getElementById('blockChanceValue').textContent = chance + '%';
            document.getElementById('blockChanceSlider').value = chance;
        }

        if (document.getElementById('holdMinValue')) {
            document.getElementById('holdMinValue').textContent = config.holdLengthMin || 50;
            document.getElementById('holdMinSlider').value = config.holdLengthMin || 50;
        }

        if (document.getElementById('holdMaxValue')) {
            document.getElementById('holdMaxValue').textContent = config.holdLengthMax || 150;
            document.getElementById('holdMaxSlider').value = config.holdLengthMax || 150;
        }

        if (document.getElementById('delayMinValue')) {
            document.getElementById('delayMinValue').textContent = config.delayMin || 100;
            document.getElementById('delayMinSlider').value = config.delayMin || 100;
        }

        if (document.getElementById('delayMaxValue')) {
            document.getElementById('delayMaxValue').textContent = config.delayMax || 300;
            document.getElementById('delayMaxSlider').value = config.delayMax || 300;
        }

        const onlyWhileClicking = document.querySelector('.checkbox[data-setting="onlyWhileClicking"]');
        if (onlyWhileClicking) {
            if (config.onlyWhileClicking !== false) onlyWhileClicking.classList.add('checked');
            else onlyWhileClicking.classList.remove('checked');
        }

        lastSavedConfig = { ...config };
    } catch (error) {
        console.error('Apply settings error:', error);
    }
}

async function saveSettings(updates) {
    if (isUpdatingFromServer) return;
    
    const token = localStorage.getItem('token');
    currentConfig = { ...currentConfig, ...updates };

    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`${API_URL}/agent/settings`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(currentConfig)
            });

            if (response.ok) {
                lastSavedConfig = { ...currentConfig };
            }
        } catch (error) {
            console.error('Save settings error:', error);
        }
    }, 500);
}

// ==================== UI HANDLERS ====================
function updateCps(value) {
    if (isUpdatingFromServer) return;
    const cpsValue = parseFloat(value);
    document.getElementById('cpsValue').textContent = cpsValue.toFixed(1);
    document.getElementById('cpsRange').textContent = calculateCpsRange(cpsValue);
    saveSettings({ cps: cpsValue });
}

function updateExhaustDrop(value) {
    if (isUpdatingFromServer) return;
    document.getElementById('exhaustDropValue').textContent = parseFloat(value).toFixed(1);
    saveSettings({ exhaustDropCps: parseFloat(value) });
}

function updateExhaustChance(value) {
    if (isUpdatingFromServer) return;
    document.getElementById('exhaustChanceValue').textContent = parseInt(value) + '%';
    saveSettings({ exhaustChance: parseInt(value) });
}

function updateSpikeIncrease(value) {
    if (isUpdatingFromServer) return;
    document.getElementById('spikeIncreaseValue').textContent = parseFloat(value).toFixed(1);
    saveSettings({ spikeIncreaseCps: parseFloat(value) });
}

function updateSpikeChance(value) {
    if (isUpdatingFromServer) return;
    document.getElementById('spikeChanceValue').textContent = parseInt(value) + '%';
    saveSettings({ spikeChance: parseInt(value) });
}

function updateBlockChance(value) {
    if (isUpdatingFromServer) return;
    document.getElementById('blockChanceValue').textContent = parseInt(value) + '%';
    saveSettings({ blockChance: parseInt(value) });
}

function updateHoldMin(value) {
    if (isUpdatingFromServer) return;
    const holdValue = parseInt(value);
    document.getElementById('holdMinValue').textContent = holdValue;
    
    const maxSlider = document.getElementById('holdMaxSlider');
    if (holdValue > parseInt(maxSlider.value)) {
        maxSlider.value = holdValue;
        document.getElementById('holdMaxValue').textContent = holdValue;
    }
    
    saveSettings({ holdLengthMin: holdValue });
}

function updateHoldMax(value) {
    if (isUpdatingFromServer) return;
    const holdValue = parseInt(value);
    document.getElementById('holdMaxValue').textContent = holdValue;
    
    const minSlider = document.getElementById('holdMinSlider');
    if (holdValue < parseInt(minSlider.value)) {
        minSlider.value = holdValue;
        document.getElementById('holdMinValue').textContent = holdValue;
    }
    
    saveSettings({ holdLengthMax: holdValue });
}

function updateDelayMin(value) {
    if (isUpdatingFromServer) return;
    const delayValue = parseInt(value);
    document.getElementById('delayMinValue').textContent = delayValue;
    
    const maxSlider = document.getElementById('delayMaxSlider');
    if (delayValue > parseInt(maxSlider.value)) {
        maxSlider.value = delayValue;
        document.getElementById('delayMaxValue').textContent = delayValue;
    }
    
    saveSettings({ delayMin: delayValue });
}

function updateDelayMax(value) {
    if (isUpdatingFromServer) return;
    const delayValue = parseInt(value);
    document.getElementById('delayMaxValue').textContent = delayValue;
    
    const minSlider = document.getElementById('delayMinSlider');
    if (delayValue < parseInt(minSlider.value)) {
        minSlider.value = delayValue;
        document.getElementById('delayMinValue').textContent = delayValue;
    }
    
    saveSettings({ delayMax: delayValue });
}

function toggleModule(moduleName) {
    if (isUpdatingFromServer) return;
    const toggle = document.querySelector(`.module-toggle[data-module="${moduleName}"]`);
    if (!toggle) return;
    
    toggle.classList.toggle('active');
    const isActive = toggle.classList.contains('active');
    
    if (moduleName === 'leftclicker') {
        saveSettings({ enabled: isActive });
    } else if (moduleName === 'blockhit') {
        saveSettings({ blockhitEnabled: isActive });
    }
}

function toggleModuleSettings(moduleName) {
    const settings = document.getElementById(`${moduleName}-settings`);
    const btn = document.querySelector(`[onclick="toggleModuleSettings('${moduleName}')"]`);
    
    if (settings && btn) {
        const isOpen = settings.classList.contains('show');
        if (isOpen) {
            btn.classList.remove('expanded');
            settings.classList.remove('show');
        } else {
            btn.classList.add('expanded');
            settings.classList.add('show');
        }
    }
}

function toggleMiniSetting(element, settingName) {
    if (isUpdatingFromServer) return;
    element.classList.toggle('active');
    saveSettings({ [settingName]: element.classList.contains('active') });
}

function toggleCheckbox(element, settingName) {
    if (isUpdatingFromServer) return;
    element.classList.toggle('checked');
    saveSettings({ [settingName]: element.classList.contains('checked') });
}

function recordKeybind(input) {
    if (!input) return;
    input.classList.add('recording');
    input.value = 'Press any key...';
    
    const handler = (e) => {
        e.preventDefault();
        input.value = getKeyName(e.keyCode);
        input.classList.remove('recording');
        saveSettings({ hotkeyCode: e.keyCode });
        document.removeEventListener('keydown', handler);
    };
    
    document.addEventListener('keydown', handler);
}

function getKeyName(keyCode) {
    const keyMap = {
        112: 'F1', 113: 'F2', 114: 'F3', 115: 'F4', 116: 'F5', 117: 'F6',
        118: 'F7', 119: 'F8', 120: 'F9', 121: 'F10', 122: 'F11', 123: 'F12',
        16: 'SHIFT', 17: 'CTRL', 18: 'ALT', 20: 'CAPS',
        32: 'SPACE', 13: 'ENTER', 8: 'BACKSPACE', 9: 'TAB'
    };
    return keyMap[keyCode] || String.fromCharCode(keyCode).toUpperCase();
}

function switchSection(event, section) {
    if (!event) return;
    event.preventDefault();
    
    const navItem = event.currentTarget;
    if (navItem && navItem.classList.contains('locked')) {
        alert('This section requires an active license.');
        section = 'settings';
    }
    
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    const targetNav = document.querySelector(`.nav-item[data-section="${section}"]`);
    if (targetNav) targetNav.classList.add('active');
    
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    const sectionEl = document.getElementById(section + '-section');
    if (sectionEl) sectionEl.classList.add('active');
    
    const titles = {
        'modules': { text: 'Modules', icon: 'fa-th-large' },
        'settings': { text: 'Settings', icon: 'fa-cog' },
        'download': { text: 'Download', icon: 'fa-download' }
    };
    
    if (titles[section]) {
        document.getElementById('pageTitle').textContent = titles[section].text;
        document.getElementById('pageTitleIcon').className = 'fas ' + titles[section].icon;
    }
}

function switchSettingsTab(tabName) {
    document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));
    
    event.currentTarget.classList.add('active');
    const tabContent = document.getElementById(`${tabName}-tab`);
    if (tabContent) tabContent.classList.add('active');
}

async function activateLicense() {
    const token = localStorage.getItem('token');
    const licenseKeyInput = document.getElementById('licenseKeyInput');
    if (!licenseKeyInput || !licenseKeyInput.value.trim()) {
        alert('Please enter a license key');
        return;
    }
    try {
        const response = await fetch(`${API_URL}/auth/activate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ licenseKey: licenseKeyInput.value.trim() })
        });
        const data = await response.json();
        if (response.ok) {
            alert('License activated successfully!');
            licenseKeyInput.value = '';
            await loadUserProfile();
        } else {
            alert(data.error || 'Failed to activate license');
        }
    } catch (error) {
        alert('Failed to activate license');
    }
}

async function changeEmail() {
    const token = localStorage.getItem('token');
    const newEmailInput = document.getElementById('newEmailInput');
    const emailSuccess = document.getElementById('emailSuccess');
    const emailError = document.getElementById('emailError');
    const emailErrorText = document.getElementById('emailErrorText');
    
    emailSuccess.classList.remove('show');
    emailError.classList.remove('show');
    
    if (!newEmailInput.value.trim()) {
        emailErrorText.textContent = 'Please enter a new email';
        emailError.classList.add('show');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/user/profile`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: newEmailInput.value.trim() })
        });
        const data = await response.json();
        if (response.ok) {
            emailSuccess.classList.add('show');
            newEmailInput.value = '';
            await loadUserProfile();
        } else {
            emailErrorText.textContent = data.error || 'Failed to update email';
            emailError.classList.add('show');
        }
    } catch (error) {
        emailErrorText.textContent = 'Failed to update email';
        emailError.classList.add('show');
    }
}

async function changePassword() {
    const token = localStorage.getItem('token');
    const currentPasswordInput = document.getElementById('currentPasswordInput');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const confirmPasswordInput = document.getElementById('confirmPasswordInput');
    const passwordSuccess = document.getElementById('passwordSuccess');
    const passwordError = document.getElementById('passwordError');
    const passwordErrorText = document.getElementById('passwordErrorText');
    
    passwordSuccess.classList.remove('show');
    passwordError.classList.remove('show');
    
    if (!currentPasswordInput.value) {
        passwordErrorText.textContent = 'Please enter your current password';
        passwordError.classList.add('show');
        return;
    }
    
    if (!newPasswordInput.value) {
        passwordErrorText.textContent = 'Please enter a new password';
        passwordError.classList.add('show');
        return;
    }
    
    if (newPasswordInput.value !== confirmPasswordInput.value) {
        passwordErrorText.textContent = 'Passwords do not match';
        passwordError.classList.add('show');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/user/profile`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: currentPasswordInput.value,
                newPassword: newPasswordInput.value
            })
        });
        const data = await response.json();
        if (response.ok) {
            passwordSuccess.classList.add('show');
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
        } else {
            passwordErrorText.textContent = data.error || 'Failed to update password';
            passwordError.classList.add('show');
        }
    } catch (error) {
        passwordErrorText.textContent = 'Failed to update password';
        passwordError.classList.add('show');
    }
}

function generateRandomName() {
    const adjectives = ['swift', 'shadow', 'silent', 'ghost', 'phantom', 'stealth'];
    const nouns = ['client', 'app', 'tool', 'utility', 'helper', 'agent'];
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const noun = nouns[Math.floor(Math.random() * nouns.length)];
    const random = Math.floor(Math.random() * 10000);
    return `${adj}_${noun}_${random}`;
}

async function downloadClient(useRandomName) {
    const token = localStorage.getItem('token');
    const statusEl = document.getElementById('downloadStatus');
    const statusText = document.getElementById('downloadStatusText');
    
    try {
        let filename;
        if (useRandomName) {
            filename = generateRandomName();
        } else {
            const customInput = document.getElementById('customFilename');
            filename = customInput.value.trim() || 'asce';
            filename = filename.replace(/\.exe$/i, '');
        }
        
        statusText.textContent = `Preparing ${filename}.exe...`;
        statusEl.classList.add('show');
        
        const response = await fetch(`${API_URL}/download/client?filename=${encodeURIComponent(filename)}`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.exe`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        statusText.textContent = `Downloaded ${filename}.exe`;
        setTimeout(() => statusEl.classList.remove('show'), 5000);
    } catch (error) {
        statusEl.className = 'error-message show';
        statusText.textContent = 'Download failed';
        setTimeout(() => {
            statusEl.classList.remove('show');
            statusEl.className = 'success-message';
        }, 5000);
    }
}

function connectWebSocket(token) {
    try {
        ws = new WebSocket(`wss://asce-f5us.onrender.com?token=${token}`);
        
        ws.onopen = () => console.log('WebSocket connected');
        ws.onclose = () => setTimeout(() => connectWebSocket(token), 3000);
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'agent_heartbeat') {
                    const dot = document.getElementById('connectionDot');
                    const text = document.getElementById('connectionText');
                    if (dot) dot.classList.add('connected');
                    if (text) text.textContent = 'connected';
                }
                
                if (data.type === 'settings_updated') {
                    isUpdatingFromServer = true;
                    applySettings(data.settings);
                    isUpdatingFromServer = false;
                }
            } catch (error) {
                console.error('WebSocket message error:', error);
            }
        };
    } catch (error) {
        console.error('WebSocket error:', error);
    }
}

async function logout() {
    if (!confirm('Are you sure you want to logout?')) return;
    
    const token = localStorage.getItem('token');
    try {
        await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    } catch (error) {}
    
    localStorage.clear();
    window.location.href = 'auth.html';
}

window.addEventListener('load', init);
    </script>
</body>
</html>
