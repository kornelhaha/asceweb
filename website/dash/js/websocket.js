const API_URL=window.API_URL||'https://asce-f5us.onrender.com';let ws=null;let reconnectAttempts=0;const MAX_RECONNECT_ATTEMPTS=5;const RECONNECT_DELAY=2000;const HEARTBEAT_INTERVAL=5000;let heartbeatTimer=null;let isUpdatingFromServer=false;function connectWebSocket(){if(!localStorage.getItem('token'))return;const token=localStorage.getItem('token');const wsUrl=API_URL.replace('https://','wss://').replace('http://','ws://')+`/ws?token=${token}`;console.log('[WS] Connecting...');updateConnectionStatus(false);ws=new WebSocket(wsUrl);ws.onopen=()=>{console.log('[WS] Connected');reconnectAttempts=0;updateConnectionStatus(true);startHeartbeat();syncSettings()};ws.onmessage=(event)=>{try{const data=JSON.parse(event.data);handleWebSocketMessage(data)}catch(error){console.error('[WS] Message error:',error)}};ws.onerror=(error)=>{console.error('[WS] Error:',error);updateConnectionStatus(false)};ws.onclose=()=>{console.log('[WS] Disconnected');updateConnectionStatus(false);stopHeartbeat();if(reconnectAttempts<MAX_RECONNECT_ATTEMPTS){reconnectAttempts++;console.log(`[WS] Reconnecting in ${RECONNECT_DELAY/1000}s (attempt ${reconnectAttempts})`);setTimeout(connectWebSocket,RECONNECT_DELAY)}else{console.error('[WS] Max reconnection attempts reached')}}}function handleWebSocketMessage(data){switch(data.type){case'connected':console.log('[WS]',data.message);break;case'settings_updated':console.log('[WS] Settings updated from server');isUpdatingFromServer=true;applySettings(data.settings);setTimeout(()=>isUpdatingFromServer=false,100);break;case'agent_heartbeat':break;case'heartbeat_ack':break;case'license_revoked':alert('Your license has been revoked. Please activate with a new license key.');window.location.href='/settings';break}}function startHeartbeat(){stopHeartbeat();heartbeatTimer=setInterval(()=>{if(ws&&ws.readyState===WebSocket.OPEN){ws.send(JSON.stringify({type:'heartbeat'}))}},HEARTBEAT_INTERVAL)}function stopHeartbeat(){if(heartbeatTimer){clearInterval(heartbeatTimer);heartbeatTimer=null}}function updateConnectionStatus(connected){const dot=document.getElementById('connectionDot');const text=document.getElementById('connectionText');if(dot&&text){if(connected){dot.style.background='#0f0';dot.style.boxShadow='0 0 10px rgba(0,255,0,0.5)';text.textContent='connected'}else{dot.style.background='#f00';dot.style.boxShadow='0 0 10px rgba(255,0,0,0.5)';text.textContent='not connected'}}}async function syncSettings(){try{const response=await fetch(`${API_URL}/api/agent/settings`,{headers:{Authorization:`Bearer ${localStorage.getItem('token')}`}});if(!response.ok)return;const settings=await response.json();console.log('[SYNC] Settings loaded from server');isUpdatingFromServer=true;applySettings(settings);setTimeout(()=>isUpdatingFromServer=false,100)}catch(error){console.error('[SYNC] Error:',error)}}function disconnectWebSocket(){if(ws){ws.close();ws=null}stopHeartbeat()}
