let ws = null; function connectWebSocket(token) { try { ws = new WebSocket(`wss://asce-f5us.onrender.com?token=${token}`); ws.onopen = () => console.log('Connected'); ws.onclose = () => { setTimeout(() => connectWebSocket(token), 3000); }; ws.onmessage = (event) => { try { const data = JSON.parse(event.data); if (data.type === 'agent_heartbeat') { const dot = document.getElementById('connectionDot'); const text = document.getElementById('connectionText'); if (dot) dot.classList.add('connected'); if (text) text.textContent = 'connected'; } if (data.type === 'settings_updated') { let isEcho = true; for (let key in data.settings) { if (lastSentConfig[key] === undefined || Math.abs(lastSentConfig[key] - data.settings[key]) > 0.01) { isEcho = false; break; } } if (isEcho) { return; } isUpdatingFromServer = true; Object.assign(currentConfig, data.settings); applySettings(data.settings); setTimeout(() => { isUpdatingFromServer = false; }, 500); } } catch (error) { console.error('Error:', error); } }; } catch (error) { console.error('Failed to connect:', error); } }