function isSessionValid() { const token = localStorage.getItem('token'); const loginTime = localStorage.getItem('loginTime'); if (!token || !loginTime) return false; const elapsed = Date.now() - parseInt(loginTime); return elapsed <= 60 * 60 * 1000; } async function loadUserProfile() { const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/user/profile`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { currentUser = await response.json(); updateUserDisplay(); checkLicenseStatus(); } } catch (error) { console.error('Profile load error:', error); } } async function loadSettings() { const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/agent/settings`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { isUpdatingFromServer = true; const serverConfig = await response.json(); currentConfig = { ...serverConfig }; applySettings(currentConfig); isUpdatingFromServer = false; } } catch (error) { console.error('[LOAD] ✗ Error:', error); } } function saveSettings(updates) { if (isUpdatingFromServer) { console.log('[SAVE] Blocked - server is updating'); return; } Object.assign(pendingUpdates, updates); Object.assign(currentConfig, updates); if (saveTimeout) { clearTimeout(saveTimeout); } saveTimeout = setTimeout(async () => { if (Object.keys(pendingUpdates).length === 0) return; const toSend = { ...pendingUpdates }; pendingUpdates = {}; console.log('[SAVE] Sending to server:', toSend); Object.assign(lastSentConfig, toSend); const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/agent/settings`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(toSend) }); if (response.ok) { console.log('[SAVE] ✓ Saved successfully'); } else { console.error('[SAVE] ✗ Failed to save'); } } catch (error) { console.error('[SAVE] ✗ Error:', error); } setTimeout(() => { Object.keys(toSend).forEach(key => { delete lastSentConfig[key]; }); }, 2000); }, SAVE_DEBOUNCE_MS); } async function activateLicense() { const token = localStorage.getItem('token'); const licenseKeyInput = document.getElementById('licenseKeyInput'); if (!licenseKeyInput || !licenseKeyInput.value.trim()) { alert('Please enter a license key'); return; } try { const response = await fetch(`${API_URL}/auth/activate`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ licenseKey: licenseKeyInput.value.trim() }) }); const data = await response.json(); if (response.ok) { alert('License activated successfully!'); licenseKeyInput.value = ''; await loadUserProfile(); } else { alert(data.error || 'Failed to activate license'); } } catch (error) { alert('Failed to activate license'); } } async function changeEmail() { const token = localStorage.getItem('token'); const newEmailInput = document.getElementById('newEmailInput'); const emailSuccess = document.getElementById('emailSuccess'); const emailError = document.getElementById('emailError'); const emailErrorText = document.getElementById('emailErrorText'); emailSuccess.classList.remove('show'); emailError.classList.remove('show'); if (!newEmailInput.value.trim()) { emailErrorText.textContent = 'Please enter a new email'; emailError.classList.add('show'); return; } try { const response = await fetch(`${API_URL}/user/profile`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ email: newEmailInput.value.trim() }) }); const data = await response.json(); if (response.ok) { emailSuccess.classList.add('show'); newEmailInput.value = ''; await loadUserProfile(); } else { emailErrorText.textContent = data.error || 'Failed to update email'; emailError.classList.add('show'); } } catch (error) { emailErrorText.textContent = 'Failed to update email'; emailError.classList.add('show'); } } async function changePassword() { const token = localStorage.getItem('token'); const currentPasswordInput = document.getElementById('currentPasswordInput'); const newPasswordInput = document.getElementById('newPasswordInput'); const confirmPasswordInput = document.getElementById('confirmPasswordInput'); const passwordSuccess = document.getElementById('passwordSuccess'); const passwordError = document.getElementById('passwordError'); const passwordErrorText = document.getElementById('passwordErrorText'); passwordSuccess.classList.remove('show'); passwordError.classList.remove('show'); if (!currentPasswordInput.value) { passwordErrorText.textContent = 'Please enter your current password'; passwordError.classList.add('show'); return; } if (!newPasswordInput.value) { passwordErrorText.textContent = 'Please enter a new password'; passwordError.classList.add('show'); return; } if (newPasswordInput.value !== confirmPasswordInput.value) { passwordErrorText.textContent = 'Passwords do not match'; passwordError.classList.add('show'); return; } try { const response = await fetch(`${API_URL}/user/profile`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ currentPassword: currentPasswordInput.value, newPassword: newPasswordInput.value }) }); const data = await response.json(); if (response.ok) { passwordSuccess.classList.add('show'); currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; } else { passwordErrorText.textContent = data.error || 'Failed to update password'; passwordError.classList.add('show'); } } catch (error) { passwordErrorText.textContent = 'Failed to update password'; passwordError.classList.add('show'); } } function generateRandomName() { const adjectives = ['swift', 'shadow', 'silent', 'ghost', 'phantom', 'stealth']; const nouns = ['client', 'app', 'tool', 'utility', 'helper', 'agent']; const adj = adjectives[Math.floor(Math.random() * adjectives.length)]; const noun = nouns[Math.floor(Math.random() * nouns.length)]; const random = Math.floor(Math.random() * 10000); return `${adj}_${noun}_${random}`; } async function downloadClient(useRandomName) { const token = localStorage.getItem('token'); const statusEl = document.getElementById('downloadStatus'); const statusText = document.getElementById('downloadStatusText'); try { let filename; if (useRandomName) { filename = generateRandomName(); } else { const customInput = document.getElementById('customFilename'); filename = customInput.value.trim() || 'asce'; filename = filename.replace(/\.exe$/i, ''); } statusText.textContent = `Preparing ${filename}.exe...`; statusEl.classList.add('show'); const response = await fetch(`${API_URL}/download/client?filename=${encodeURIComponent(filename)}`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) throw new Error('Download failed'); const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${filename}.exe`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); statusText.textContent = `Downloaded ${filename}.exe`; setTimeout(() => statusEl.classList.remove('show'), 5000); } catch (error) { statusEl.className = 'error-message show'; statusText.textContent = 'Download failed'; setTimeout(() => { statusEl.classList.remove('show'); statusEl.className = 'success-message'; }, 5000); } } async function logout() { if (!confirm('Are you sure you want to logout?')) return; const token = localStorage.getItem('token'); try { await fetch(`${API_URL}/auth/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); } catch (error) {} currentConfig = {}; localStorage.clear(); window.location.href = 'auth.html'; }
