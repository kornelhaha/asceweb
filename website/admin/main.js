const API_URL = 'https://asce-f5us.onrender.com/api'; let currentPage = 1; let totalPages = 1; let adminData = null; function checkAuth() { const token = localStorage.getItem('token'); const user = localStorage.getItem('user'); if (!token || !user) { window.location.href = 'auth.html'; return null; } const userData = JSON.parse(user); if (userData.role !== 'admin') { window.location.href = 'dash.html'; return null; } adminData = userData; return { token, user: userData }; } async function init() { const auth = checkAuth(); if (!auth) return; document.getElementById('adminName').textContent = adminData.username; document.getElementById('adminAvatar').textContent = adminData.username.charAt(0).toUpperCase(); setupNavigation(); loadStats(auth.token); loadUsers(auth.token); loadLicenses(auth.token); loadActivity(auth.token, 1); setInterval(() => loadStats(auth.token), 5000); } function setupNavigation() { const navItems = document.querySelectorAll('.nav-item'); const sections = document.querySelectorAll('.content-section'); navItems.forEach(item => { item.addEventListener('click', () => { navItems.forEach(nav => nav.classList.remove('active')); item.classList.add('active'); sections.forEach(section => section.classList.remove('active')); const sectionId = item.dataset.section + '-section'; const section = document.getElementById(sectionId); if (section) { section.classList.add('active'); } }); }); } async function loadStats(token) { try { const response = await fetch(`${API_URL}/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const stats = await response.json(); document.getElementById('totalUsers').textContent = stats.totalUsers || 0; document.getElementById('onlineUsers').textContent = stats.onlineUsers || 0; document.getElementById('activeLicenses').textContent = stats.activeLicenses || 0; document.getElementById('totalClicks').textContent = (stats.totalClicks || 0).toLocaleString(); } } catch (error) { console.error('Error loading stats:', error); } } async function loadUsers(token) { try { const response = await fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const users = await response.json(); displayUsers(users); } } catch (error) { console.error('Error loading users:', error); } } function displayUsers(users) { const tbody = document.getElementById('userTableBody'); if (users.length === 0) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state">No users found</div></td></tr>'; return; } tbody.innerHTML = users.map(user => ` <tr> <td> <div class="user-info-cell"> <div class="user-avatar-small">${user.username.charAt(0).toUpperCase()}</div> <div> <div>${user.username}</div> <div style="font-size: 0.8em; color: #666;">${user.role}</div> </div> </div> </td> <td>${user.email}</td> <td><span class="badge ${user.status}">${user.status.toUpperCase()}</span></td> <td>${formatDate(user.createdAt)}</td> <td>${user.lastSeen ? formatDate(user.lastSeen) : 'Never'}</td> <td> <div class="action-buttons"> <button class="btn btn-small btn-outline ${user.status === 'banned' ? '' : 'btn-danger'}" onclick="toggleBanUser('${user._id}', ${user.status === 'banned'})"> ${user.status === 'banned' ? 'UNBAN' : 'BAN'} </button> <button class="btn btn-small btn-outline btn-danger" onclick="deleteUser('${user._id}')">DELETE</button> </div> </td> </tr> `).join(''); } async function loadLicenses(token) { try { const response = await fetch(`${API_URL}/admin/licenses`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const licenses = await response.json(); displayLicenses(licenses); } } catch (error) { console.error('Error loading licenses:', error); } } function displayLicenses(licenses) { const tbody = document.getElementById('licenseTableBody'); if (licenses.length === 0) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">No licenses generated yet</div></td></tr>'; return; } tbody.innerHTML = licenses.map(license => ` <tr> <td><code style="font-family: 'Space Mono', monospace;">${license.key}</code></td> <td><span class="badge">${license.type.toUpperCase()}</span></td> <td><span class="badge ${license.status}">${license.status.toUpperCase()}</span></td> <td>${license.usedBy ? license.usedBy.username : 'Unused'}</td> <td>${formatDate(license.createdAt)}</td> <td>${license.expiresAt ? formatDate(license.expiresAt) : 'Never'}</td> <td> <button class="btn btn-small btn-outline btn-danger" onclick="revokeLicense('${license._id}')">REVOKE</button> </td> </tr> `).join(''); } async function loadActivity(token, page = 1) { try { const response = await fetch(`${API_URL}/admin/activity?page=${page}&limit=20`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { const data = await response.json(); displayActivity(data.activities); displayPagination(data.pagination); currentPage = page; totalPages = data.pagination.totalPages; } } catch (error) { console.error('Error loading activity:', error); } } function displayActivity(activities) { const container = document.getElementById('activityList'); if (activities.length === 0) { container.innerHTML = '<div class="empty-state">No recent activity</div>'; return; } container.innerHTML = activities.map(activity => ` <div class="activity-item"> <div class="activity-time">${formatDate(activity.timestamp)}</div> <div class="activity-text"><strong>${activity.username}</strong> - ${activity.action}${activity.details ? ': ' + activity.details : ''}</div> </div> `).join(''); } function displayPagination(pagination) { const paginationEl = document.getElementById('activityPagination'); const pageNumbersEl = document.getElementById('pageNumbers'); const prevBtn = document.getElementById('prevPage'); const nextBtn = document.getElementById('nextPage'); if (pagination.totalPages <= 1) { paginationEl.style.display = 'none'; return; } paginationEl.style.display = 'flex'; prevBtn.disabled = !pagination.hasPrev; nextBtn.disabled = !pagination.hasNext; let pages = []; const current = pagination.currentPage; const total = pagination.totalPages; pages.push(1); for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) { if (!pages.includes(i)) pages.push(i); } if (total > 1 && !pages.includes(total)) { pages.push(total); } pageNumbersEl.innerHTML = pages.map((page, index) => { const prevPage = pages[index - 1]; const gap = prevPage && page - prevPage > 1 ? '<span style="padding: 0 8px;">...</span>' : ''; return ` ${gap} <button class="pagination-btn ${page === current ? 'active' : ''}" onclick="goToPage(${page})">${page}</button> `; }).join(''); } function changePage(delta) { const newPage = currentPage + delta; if (newPage >= 1 && newPage <= totalPages) { const token = localStorage.getItem('token'); loadActivity(token, newPage); } } function goToPage(page) { const token = localStorage.getItem('token'); loadActivity(token, page); } function refreshActivity() { const token = localStorage.getItem('token'); loadActivity(token, currentPage); } function showCreateUserModal() { document.getElementById('createUserModal').classList.add('show'); } function showGenerateLicenseModal() { document.getElementById('generateLicenseModal').classList.add('show'); document.getElementById('generatedKeyDisplay').style.display = 'none'; } function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); if (modalId === 'createUserModal') { document.getElementById('newUsername').value = ''; document.getElementById('newEmail').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('create-user-error').classList.remove('show'); document.getElementById('create-user-success').classList.remove('show'); } else if (modalId === 'generateLicenseModal') { document.getElementById('licenseType').value = 'month'; document.getElementById('licenseMaxUses').value = '1'; document.getElementById('generate-license-error').classList.remove('show'); document.getElementById('generate-license-success').classList.remove('show'); } } async function createUser(e) { e.preventDefault(); const errorEl = document.getElementById('create-user-error'); const successEl = document.getElementById('create-user-success'); errorEl.classList.remove('show'); successEl.classList.remove('show'); const btn = document.getElementById('createUserBtn'); btn.textContent = 'CREATING...'; btn.disabled = true; const username = document.getElementById('newUsername').value; const email = document.getElementById('newEmail').value; const password = document.getElementById('newPassword').value; const role = document.getElementById('newRole').value; const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/admin/users`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ username, email, password, role }) }); const data = await response.json(); if (response.ok) { successEl.textContent = 'User created successfully!'; successEl.classList.add('show'); loadUsers(token); loadStats(token); setTimeout(() => closeModal('createUserModal'), 2000); } else { errorEl.textContent = data.error || 'Failed to create user'; errorEl.classList.add('show'); } } catch (error) { console.error('Create user error:', error); errorEl.textContent = 'Network error'; errorEl.classList.add('show'); } finally { btn.textContent = 'CREATE'; btn.disabled = false; } } async function generateLicense(e) { e.preventDefault(); const errorEl = document.getElementById('generate-license-error'); const successEl = document.getElementById('generate-license-success'); errorEl.classList.remove('show'); successEl.classList.remove('show'); const btn = document.getElementById('generateLicenseBtn'); btn.textContent = 'GENERATING...'; btn.disabled = true; const type = document.getElementById('licenseType').value; const maxUses = parseInt(document.getElementById('licenseMaxUses').value); const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/admin/licenses/generate`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ type, maxUses }) }); const data = await response.json(); if (response.ok) { document.getElementById('generatedKey').textContent = data.key; document.getElementById('generatedKeyDisplay').style.display = 'block'; successEl.textContent = 'License generated successfully!'; successEl.classList.add('show'); loadLicenses(token); loadStats(token); } else { errorEl.textContent = data.error || 'Failed to generate license'; errorEl.classList.add('show'); } } catch (error) { console.error('Generate license error:', error); errorEl.textContent = 'Network error'; errorEl.classList.add('show'); } finally { btn.textContent = 'GENERATE'; btn.disabled = false; } } function copyLicenseKey() { const key = document.getElementById('generatedKey').textContent; navigator.clipboard.writeText(key).then(() => { alert('License key copied to clipboard!'); }); } async function toggleBanUser(id, isCurrentlyBanned) { if (!confirm(`Are you sure you want to ${isCurrentlyBanned ? 'unban' : 'ban'} this user?`)) return; const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/admin/users/${id}/ban`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ banned: !isCurrentlyBanned }) }); if (response.ok) { loadUsers(token); } else { alert('Failed to update user status'); } } catch (error) { console.error('Ban user error:', error); alert('Network error'); } } async function deleteUser(id) { if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return; const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/admin/users/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { loadUsers(token); loadStats(token); } else { alert('Failed to delete user'); } } catch (error) { console.error('Delete user error:', error); alert('Network error'); } } async function revokeLicense(id) { if (!confirm('Are you sure you want to revoke this license? The user will need to activate a new license.')) return; const token = localStorage.getItem('token'); try { const response = await fetch(`${API_URL}/admin/licenses/${id}/revoke`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) { alert('License revoked successfully. The user has been notified.'); loadLicenses(token); loadStats(token); loadUsers(token); } else { alert('Failed to revoke license'); } } catch (error) { console.error('Revoke license error:', error); alert('Network error'); } } function formatDate(dateString) { const date = new Date(dateString); return date.toLocaleDateString() + ' ' + date.toLocaleTimeString(); } function logout() { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'auth.html'; } window.addEventListener('load', init);